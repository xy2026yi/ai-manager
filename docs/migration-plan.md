# AI Manager 迁移计划

> **从 Python/FastAPI 到 Rust/Tauri 的完整迁移方案**

**生成时间**: 2025-11-14  
**预计工期**: 15-22 天  
**目标**: 将 Python/FastAPI 的 AI Manager 项目迁移到 Rust/Tauri 架构，实现更轻量、高性能的桌面应用

---

## 📋 目录

1. [项目概述](#项目概述)
2. [原项目分析](#原项目分析)
3. [目标架构设计](#目标架构设计)
4. [技术栈对比](#技术栈对比)
5. [详细任务列表](#详细任务列表)
6. [时间估算](#时间估算)
7. [风险评估](#风险评估)
8. [验收标准](#验收标准)

---

## 项目概述

### 迁移目标

将现有的 Python/FastAPI AI Manager 项目迁移到 Rust/Tauri 架构，保持所有功能完整性，同时实现：

- **体积优化**: 从潜在的 100MB+ (Electron) 降至 < 15MB (Tauri)
- **性能提升**: 启动时间 < 2s，内存占用 < 100MB
- **跨平台**: 支持 Windows/macOS/Linux
- **数据兼容**: 完全兼容原数据库和加密数据
- **功能完整**: 保留所有现有功能

### 核心功能

1. **供应商管理**: Claude 和 Codex 供应商的 CRUD 操作
2. **配置生成**: 自动生成 `~/.claude/settings.json` 和 `~/.codex/config.toml`
3. **Agent 指导**: 管理 Agent 指导文件（8个模板）
4. **MCP 服务器**: MCP 服务器配置管理
5. **通用配置**: 系统配置管理

---

## 原项目分析

### 技术栈

- **后端**: Python 3.13 + FastAPI + SQLAlchemy + aiosqlite
- **前端**: 原生 HTML/CSS/JavaScript (约957行)
- **数据库**: SQLite (ai_manager.db)
- **加密**: cryptography.fernet.Fernet (对称加密)
- **配置**: pydantic-settings + python-dotenv

### 数据模型

#### 1. ClaudeProvider (11个字段)
```python
id, name, url, token(加密), timeout, auto_update, 
type(paid/public_welfare), enabled(0/1), 
opus_model, sonnet_model, haiku_model
```

#### 2. CodexProvider (5个字段)
```python
id, name, url, token(加密), type, enabled
```

#### 3. AgentGuide (4个字段)
```python
id, name, type(only/and), text(完整内容)
```

#### 4. McpServer (7个字段)
```python
id, name, type, timeout, command, args(JSON), env(JSON)
```

#### 5. CommonConfig (6个字段)
```python
id, key, value, description, category, is_active
```

### 核心业务逻辑

1. **供应商唯一性**: 启用时自动禁用所有其他供应商（全局唯一）
2. **配置自动生成**: 启用供应商后自动生成配置文件
3. **加密机制**: 使用 Fernet 对称加密，密钥从环境变量加载

---

## 目标架构设计

### 技术栈

**前端**:
- React 18 + TypeScript
- Vite (构建工具)
- Tailwind CSS (样式)
- Jotai (状态管理, 3KB)
- Headless UI (无样式组件)
- React Hook Form (表单处理)
- React Router (路由)

**后端**:
- Rust + Tauri 1.5
- sqlx (数据库, 编译时类型检查)
- fernet (加密, 兼容 Python)
- handlebars (模板引擎)
- tokio (异步运行时)
- tracing (日志)

**数据库**:
- SQLite (保持一致)
- sqlx migrations (迁移管理)

### 目录结构

```
migration_ai_manager/
├── src/                        # React 前端
│   ├── components/            # UI 组件
│   │   ├── common/           # 通用组件
│   │   ├── providers/        # 供应商组件
│   │   ├── guides/           # 指导文件组件
│   │   ├── mcp/              # MCP 组件
│   │   └── config/           # 配置组件
│   ├── pages/                # 页面
│   ├── services/             # API 服务
│   ├── stores/               # Jotai 状态
│   ├── types/                # TypeScript 类型
│   ├── hooks/                # 自定义 hooks
│   └── main.tsx              # 入口
│
├── src-tauri/                 # Rust 后端
│   ├── src/
│   │   ├── commands/         # Tauri Commands
│   │   ├── services/         # 业务逻辑
│   │   ├── models.rs         # 数据模型
│   │   ├── db.rs             # 数据库
│   │   ├── crypto.rs         # 加密
│   │   └── main.rs           # 入口
│   ├── migrations/           # 数据库迁移
│   ├── icons/                # 应用图标
│   └── Cargo.toml
│
├── resources/                 # 资源文件
│   ├── templates/            # 配置模板
│   └── agent-guides/         # Agent 模板
│
└── docs/                      # 文档
    ├── migration-plan.md     # 本文件
    ├── architecture.md       # 架构文档
    ├── api-reference.md      # API 文档
    └── development-guide.md  # 开发指南
```

---

## 技术栈对比

| 维度 | 原项目 (Python) | 目标项目 (Rust/Tauri) | 优势 |
|------|-----------------|----------------------|------|
| 应用体积 | ~50MB (Python) + 潜在 100MB (Electron) | < 15MB | 体积减小 90%+ |
| 启动时间 | ~5s (Python 解释器) | < 2s (编译型) | 启动快 2.5 倍 |
| 内存占用 | ~200MB | < 100MB | 内存减半 |
| 类型安全 | Pydantic (运行时) | Rust + TypeScript (编译时) | 更早发现错误 |
| 数据库访问 | SQLAlchemy ORM | sqlx (编译时检查) | 性能更好 |
| 加密 | cryptography | fernet crate | 兼容性保持 |
| 前端 | 原生 JS (957行) | React (组件化) | 可维护性 |
| 状态管理 | 全局变量 | Jotai (原子化) | 更清晰 |

---

## 详细任务列表

### 阶段 1: 项目初始化 (预计 1-2 天)

#### 任务 1.1: 初始化 Tauri 项目骨架
- **描述**: 创建 Tauri 项目，配置 React + TypeScript + Vite + Tailwind CSS
- **依赖**: 无
- **验收标准**:
  - `npm run tauri dev` 无错误
  - Tauri 窗口正常显示
  - Tailwind 样式生效
  - TypeScript 无编译错误

#### 任务 1.2: 配置 Rust 后端依赖
- **描述**: 在 Cargo.toml 中配置 sqlx、fernet、handlebars 等依赖
- **依赖**: 1.1
- **验收标准**:
  - `cargo build` 成功
  - sqlx-cli 安装成功
  - 无依赖冲突

#### 任务 1.3: 复制图标和模板资源
- **描述**: 从原项目复制图标和 Agent 模板到新项目
- **依赖**: 1.1
- **验收标准**:
  - 图标文件完整（所有平台）
  - 8 个 Agent 模板文件复制成功

---

### 阶段 2: 数据层迁移 (预计 2-3 天)

#### 任务 2.1: 编写数据库迁移脚本
- **描述**: 使用 sqlx migrate 创建与原项目一致的 schema
- **依赖**: 1.2
- **关键点**:
  - 5 个表：claude_providers, codex_providers, agent_guides, mcp_servers, common_configs
  - 字段类型完全一致
  - 添加性能优化索引
- **验收标准**:
  - 迁移脚本无 SQL 语法错误
  - 数据库文件创建成功
  - 表结构验证通过

#### 任务 2.2: 实现 Rust 数据模型
- **描述**: 定义所有数据结构，使用 serde 和 sqlx 属性
- **依赖**: 2.1
- **验收标准**:
  - 编译无错误
  - 字段类型正确映射
  - serde 序列化测试通过

#### 任务 2.3: 实现加密服务（含 Python 兼容性测试）
- **描述**: 实现 CryptoManager，确保与 Python Fernet 兼容
- **依赖**: 2.2
- **关键点**:
  - 使用相同密钥格式 (Base64 编码的32字节)
  - 能解密 Python 加密的数据
  - Python 能解密 Rust 加密的数据
- **验收标准**:
  - 单元测试全部通过
  - Python 兼容性测试通过
  - 能解密原数据库的 token 字段

#### 任务 2.4: 实现数据库连接池
- **描述**: 实现 SqlitePool 管理，支持多线程访问
- **依赖**: 2.3
- **验收标准**:
  - 连接池初始化成功
  - 迁移自动运行
  - 无连接泄漏

#### 任务 2.5: 编写数据迁移工具
- **描述**: 创建从原数据库导入数据的命令行工具
- **依赖**: 2.4
- **功能**:
  - 读取原数据库
  - 解密旧数据
  - 重新加密
  - 导入新数据库
  - 提供 --dry-run 模式
- **验收标准**:
  - 成功迁移测试数据
  - 数据完整性校验通过
  - 1000条记录 < 10s

---

### 阶段 3: 业务逻辑层 (预计 3-5 天)

#### 任务 3.1: 实现供应商服务（ClaudeProviderService）
- **描述**: 实现 Claude 供应商 CRUD、启用逻辑、配置生成
- **依赖**: 2.4
- **关键逻辑**:
  - 创建时检查名称唯一性
  - 启用时禁用所有其他供应商
  - 自动生成 ~/.claude/settings.json
- **验收标准**:
  - CRUD 测试通过
  - 启用逻辑正确
  - 配置文件 JSON 格式正确

#### 任务 3.2: 实现供应商服务（CodexProviderService）
- **描述**: 实现 Codex 供应商 CRUD、生成 auth.json 和 config.toml
- **依赖**: 3.1
- **关键点**:
  - config.toml 使用 Handlebars 模板
  - 包含 MCP 服务器配置
- **验收标准**:
  - auth.json 和 config.toml 正确生成
  - TOML 格式验证通过

#### 任务 3.3: 实现 Agent 指导文件服务
- **描述**: 实现 AgentGuideService，支持 CRUD 和初始化导入
- **依赖**: 2.4, 1.3
- **验收标准**:
  - 初始化导入 8 个文件
  - 重复导入不创建重复记录

#### 任务 3.4: 实现 MCP 服务器服务
- **描述**: 实现 McpServerService，处理 JSON 序列化
- **依赖**: 2.4
- **验收标准**:
  - JSON 字段正确序列化/反序列化
  - 无效 JSON 被拒绝

#### 任务 3.5: 实现通用配置服务
- **描述**: 实现 CommonConfigService，支持环境变量替换
- **依赖**: 2.4
- **验收标准**:
  - 环境变量正确替换 (${VAR})
  - 分类查询正常

#### 任务 3.6: 定义 Tauri Commands
- **描述**: 为所有服务方法创建 Tauri Commands
- **依赖**: 3.1, 3.2, 3.3, 3.4, 3.5
- **验收标准**:
  - 所有 commands 编译通过
  - 错误处理测试通过
  - 参数验证正确

#### 任务 3.7: 集成服务到 main.rs
- **描述**: 初始化服务、注册 Commands、配置窗口
- **依赖**: 3.6
- **验收标准**:
  - 应用正常启动
  - 所有 commands 可调用
  - 启动时初始化完成

---

### 阶段 4: 前端开发 (预计 5-7 天)

#### 任务 4.1: 定义 TypeScript 类型
- **描述**: 定义所有数据模型的 TS 接口
- **依赖**: 3.7
- **验收标准**:
  - TypeScript 编译无错误
  - 类型与 Rust 模型一致

#### 任务 4.2: 实现 API 服务层
- **描述**: 封装 Tauri Commands 调用
- **依赖**: 4.1
- **验收标准**:
  - 所有 API 方法能正常调用
  - 错误处理正确

#### 任务 4.3: 实现 Jotai 状态管理
- **描述**: 定义 atoms 和自定义 hooks
- **依赖**: 4.2
- **验收标准**:
  - atoms 定义正确
  - 状态更新触发重渲染

#### 任务 4.4: 实现通用 UI 组件
- **描述**: 创建 Button、Input、Modal、Table 等组件
- **依赖**: 1.1
- **验收标准**:
  - 所有组件渲染正常
  - 样式一致
  - 可访问性良好

#### 任务 4.5: 实现供应商管理页面
- **描述**: 创建供应商 CRUD 界面
- **依赖**: 4.3, 4.4
- **功能**:
  - Claude/Codex 选项卡
  - 列表展示
  - 创建/编辑表单 (React Hook Form)
  - 删除确认
  - 启用/禁用切换
- **验收标准**:
  - CRUD 操作功能正常
  - 表单验证生效

#### 任务 4.6: 实现 Agent 指导文件页面
- **描述**: 左侧列表、右侧编辑器布局
- **依赖**: 4.3, 4.4
- **验收标准**:
  - 编辑保存功能正常
  - 自动保存生效

#### 任务 4.7: 实现 MCP 服务器页面
- **描述**: 支持 JSON 编辑和验证
- **依赖**: 4.3, 4.4
- **验收标准**:
  - JSON 验证正确
  - 示例填充功能正常

#### 任务 4.8: 实现通用配置页面和路由
- **描述**: 配置页面 + React Router 整合
- **依赖**: 4.5, 4.6, 4.7
- **验收标准**:
  - 所有页面能正常访问
  - 路由切换正常

---

### 阶段 5: 集成测试 (预计 2-3 天)

#### 任务 5.1: 编写后端单元测试
- **描述**: Rust 服务和模块的单元测试
- **依赖**: 3.7
- **目标**: 测试覆盖率 > 80%
- **验收标准**:
  - cargo test 全部通过
  - 加密兼容性测试通过

#### 任务 5.2: 端到端集成测试
- **描述**: 完整用户流程测试
- **依赖**: 4.8, 2.5
- **测试场景**:
  - 创建供应商 → 启用 → 配置生成 → 验证
  - 数据迁移完整性
  - 并发场景
- **验收标准**:
  - 所有流程测试通过
  - 配置文件内容正确

---

### 阶段 6: 优化和部署 (预计 1-2 天)

#### 任务 6.1: 性能优化和代码分割
- **描述**: React Lazy + Suspense、图片优化、防抖
- **依赖**: 5.2
- **目标**:
  - 启动时间 < 2s
  - 内存占用 < 100MB
- **验收标准**:
  - 性能指标达标
  - 代码分割生效

#### 任务 6.2: 配置图标和应用元数据
- **描述**: 配置 tauri.conf.json
- **依赖**: 1.3
- **验收标准**:
  - 应用图标显示正确
  - 窗口标题正确

#### 任务 6.3: 多平台打包
- **描述**: 打包 Windows/macOS/Linux 版本
- **依赖**: 6.1, 6.2
- **验收标准**:
  - 所有平台成功打包
  - 应用体积 < 15MB
  - 安装和运行正常

#### 任务 6.4: 编写用户文档
- **描述**: 安装指南、使用手册、迁移指南、FAQ
- **依赖**: 6.3
- **验收标准**:
  - 所有文档完整
  - 迁移指南可操作

#### 任务 6.5: 生成技术文档
- **描述**: 架构设计、API 参考、开发指南
- **依赖**: 6.4
- **验收标准**:
  - 架构说明清晰
  - API 文档完整

---

## 时间估算

| 阶段 | 任务数 | 预计工时 | 关键路径 |
|------|--------|---------|---------|
| 阶段 1: 项目初始化 | 3 | 1-2 天 | ✓ |
| 阶段 2: 数据层迁移 | 5 | 2-3 天 | ✓ |
| 阶段 3: 业务逻辑层 | 7 | 3-5 天 | ✓ |
| 阶段 4: 前端开发 | 8 | 5-7 天 | ✓ |
| 阶段 5: 集成测试 | 2 | 2-3 天 | ✓ |
| 阶段 6: 优化和部署 | 5 | 1-2 天 | ✓ |
| **总计** | **30** | **15-22 天** | - |

**并行任务机会**:
- 任务 1.2 和 1.3 可以并行（都依赖 1.1）
- 任务 3.1, 3.3, 3.4, 3.5 可以并行（都依赖 2.4）
- 任务 4.5, 4.6, 4.7 可以并行（都依赖 4.3 和 4.4）

---

## 风险评估

### 高风险项

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| Rust 学习曲线陡峭 | 高 | 高 | 提前学习 + 参考示例项目 + AI 辅助 |
| 加密兼容性问题 | 高 | 中 | 优先实现加密测试 + 早期验证 |
| 数据迁移失败 | 高 | 低 | 备份原数据库 + 完整测试 |

### 中风险项

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| sqlx 编译时检查困难 | 中 | 中 | 使用 `cargo sqlx prepare` 离线模式 |
| UI 复杂度高 | 中 | 高 | 组件化拆分 + 使用 UI 库 |
| 跨平台兼容性 | 中 | 中 | 多平台测试 |

### 低风险项

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 性能不达预期 | 低 | 低 | 性能测试 + 优化 |

---

## 验收标准

### 功能完整性

- [ ] 所有原功能都能正常工作
- [ ] 供应商 CRUD 操作正常
- [ ] 配置文件自动生成正确
- [ ] Agent 指导文件管理正常
- [ ] MCP 服务器配置正常
- [ ] 通用配置管理正常

### 数据兼容性

- [ ] 数据库 schema 完全一致
- [ ] 能导入原数据库数据
- [ ] 加密数据能正确解密
- [ ] 配置文件格式与原项目一致

### 性能指标

- [ ] 应用体积 < 15MB
- [ ] 启动时间 < 2s
- [ ] 内存占用 < 100MB
- [ ] 操作响应 < 500ms

### 质量标准

- [ ] 测试覆盖率 > 80%
- [ ] 无内存泄漏
- [ ] 无数据竞态
- [ ] 错误处理完善

### 文档完整性

- [ ] 用户文档完整（安装、使用、迁移、FAQ）
- [ ] 技术文档完整（架构、API、开发指南）
- [ ] 所有文档使用中文
- [ ] 包含足够的截图和示例

---

## 附录

### 关键技术选型理由

1. **Tauri vs Electron**: 体积小10倍，性能更好
2. **Rust vs Node.js**: 编译时类型安全，零成本抽象
3. **sqlx vs Diesel**: 编译时 SQL 检查，更灵活
4. **Jotai vs Redux**: 轻量（3KB），原子化状态
5. **Headless UI vs Material UI**: 无样式，完全自定义

### 资源链接

- **Tauri 文档**: https://tauri.app/v1/guides/
- **sqlx 文档**: https://github.com/launchbadge/sqlx
- **Jotai 文档**: https://jotai.org/
- **Headless UI**: https://headlessui.com/
- **原项目**: /Git/project/ai-manager

---

**文档版本**: 1.0  
**最后更新**: 2025-11-14  
**维护者**: AI Migration Team
