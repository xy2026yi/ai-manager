name: æ›´æ–°æœåŠ¡å™¨åŒæ­¥

on:
  release:
    types: [published]

jobs:
  update-server:
    name: åŒæ­¥æ›´æ–°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½å‘å¸ƒæ–‡ä»¶
      uses: dsaltares/fetch-gh-release-asset@1.0
      with:
        repo: ${{ github.repository }}
        version: ${{ steps.version.outputs.version }}
        file: "SHA256SUMS"
        target: "update-server/"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ç”Ÿæˆæ›´æ–°é…ç½®
      run: |
        cat > update-server/update-config.json << EOF
        {
          "version": "${{ steps.version.outputs.version_number }}",
          "notes": "AI Manager ${{ steps.version.outputs.version }} å‘å¸ƒç‰ˆæœ¬\n\nðŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›ï¼š\n- Rust/Tauri æž¶æž„è¿ç§»å®Œæˆ\n- æ€§èƒ½æ˜¾è‘—æå‡\n- å®Œæ•´çš„ä¸­æ–‡æœ¬åœ°åŒ–æ”¯æŒ\n- å¢žå¼ºçš„ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ",
          "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "platforms": {
            "windows-x86_64": {
              "signature": "$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.version }}/assets | grep -E '"browser_download_url".*"windows.*setup.*\.exe"' | head -1 | cut -d'"' -f4 | sed 's/.*\///g')",
              "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/AI-Manager_${{ steps.version.outputs.version_number }}_x64-setup.exe"
            },
            "darwin-x86_64": {
              "signature": "$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.version }}/assets | grep -E '"browser_download_url".*"x64.*app.*\.tar\.gz"' | head -1 | cut -d'"' -f4 | sed 's/.*\///g')",
              "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/AI-Manager_${{ steps.version.outputs.version_number }}_x64.app.tar.gz"
            },
            "darwin-aarch64": {
              "signature": "$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.version }}/assets | grep -E '"browser_download_url".*"aarch64.*app.*\.tar\.gz"' | head -1 | cut -d'"' -f4 | sed 's/.*\///g')",
              "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/AI-Manager_${{ steps.version.outputs.version_number }}_aarch64.app.tar.gz"
            },
            "linux-x86_64": {
              "signature": "$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.version }}/assets | grep -E '"browser_download_url".*"amd64.*AppImage"' | head -1 | cut -d'"' -f4 | sed 's/.*\///g')",
              "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/AI-Manager_${{ steps.version.outputs.version_number }}_amd64.AppImage"
            }
          }
        }
        EOF

    - name: æŽ¨é€åˆ°æ›´æ–°æœåŠ¡å™¨
      run: |
        echo "ðŸ”„ å‡†å¤‡æŽ¨é€åˆ°æ›´æ–°æœåŠ¡å™¨..."
        echo "ðŸ“¦ æ›´æ–°é…ç½®å·²ç”Ÿæˆ"
        echo "ðŸŒ ä»¥ä¸‹å¹³å°å°†è¢«æ”¯æŒï¼š"
        cat update-server/update-config.json | jq -r '.platforms | keys[]'

    - name: åˆ›å»ºä¸‹è½½ç»Ÿè®¡
      run: |
        cat > update-server/download-stats.json << EOF
        {
          "version": "${{ steps.version.outputs.version_number }}",
          "release_date": "$(date -u +%Y-%m-%d)",
          "platforms": {
            "windows": {
              "downloads": 0,
              "last_download": null
            },
            "macos_intel": {
              "downloads": 0,
              "last_download": null
            },
            "macos_apple": {
              "downloads": 0,
              "last_download": null
            },
            "linux": {
              "downloads": 0,
              "last_download": null
            }
          }
        }
        EOF

    - name: ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨ï¼ˆæ¨¡æ‹Ÿï¼‰
      run: |
        echo "ðŸ“¤ å‡†å¤‡ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨..."
        echo "ðŸ”— æ›´æ–°åœ°å€: https://updates.ai-manager.com"
        echo "ðŸ“‹ é…ç½®æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª"
        echo "ðŸš€ ç”¨æˆ·å°†æ”¶åˆ°æ›´æ–°é€šçŸ¥"

    - name: ç”Ÿæˆæ›´æ–°é€šçŸ¥
      run: |
        echo "ðŸ“¢ ç”Ÿæˆæ›´æ–°é€šçŸ¥..."
        cat > update-server/notification.md << EOF
        # AI Manager ${{ steps.version.outputs.version }} æ›´æ–°é€šçŸ¥

        ðŸŽ‰ æ–°ç‰ˆæœ¬çŽ°å·²å¯ç”¨ï¼

        ## æ›´æ–°å†…å®¹
        - å®Œæ•´çš„ Rust/Tauri æž¶æž„è¿ç§»
        - æ˜¾è‘—çš„æ€§èƒ½æå‡å’Œå†…å­˜ä¼˜åŒ–
        - å®Œæ•´çš„ä¸­æ–‡æœ¬åœ°åŒ–æ”¯æŒ
        - å¢žå¼ºçš„ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ
        - å…¨é¢çš„æµ‹è¯•è¦†ç›–å’Œæ–‡æ¡£å®Œå–„

        ## å¦‚ä½•æ›´æ–°
        1. å¯åŠ¨ AI Manager åº”ç”¨
        2. åº”ç”¨å°†è‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬
        3. ç‚¹å‡»"ç«‹å³æ›´æ–°"æŒ‰é’®
        4. ç­‰å¾…ä¸‹è½½å’Œå®‰è£…å®Œæˆ
        5. é‡å¯åº”ç”¨å®Œæˆæ›´æ–°

        ## æ‰‹åŠ¨ä¸‹è½½
        å¦‚æžœè‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½ï¼š
        https://github.com/${{ github.repository }}/releases/latest

        ## æŠ€æœ¯æ”¯æŒ
        - ç”¨æˆ·æ‰‹å†Œ: https://docs.ai-manager.com/user-manual
        - æ•…éšœæŽ’é™¤: https://docs.ai-manager.com/troubleshooting
        - æŠ€æœ¯æ”¯æŒ: support@ai-manager.com
        EOF

    - name: æž„å»ºæ€»ç»“
      run: |
        echo "âœ… æ›´æ–°æœåŠ¡å™¨é…ç½®å®Œæˆï¼"
        echo "ðŸ“Š ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "ðŸ”„ è‡ªåŠ¨æ›´æ–°å·²å¯ç”¨"
        echo "ðŸ“± æ”¯æŒå¹³å°: Windows, macOS, Linux"
        echo "ðŸŒ æ›´æ–°æœåŠ¡å™¨: https://updates.ai-manager.com"