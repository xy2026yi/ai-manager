name: è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'src-tauri/**'
      - 'tests/**'
      - '.github/workflows/cross-platform.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'src-tauri/**'
      - 'tests/**'
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
    - cron: '0 2 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true  # é¿å…åœ¨çº¿æ•°æ®åº“æ£€æŸ¥

jobs:
  # è·¨å¹³å°æµ‹è¯•çŸ©é˜µ
  test-matrix:
    name: è·¨å¹³å°æµ‹è¯•çŸ©é˜µ
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–å¹³å°ç»§ç»­è¿è¡Œå³ä½¿ä¸€ä¸ªå¤±è´¥
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            node_arch: x64
            setup_script: setup-linux.sh
          - os: windows-latest
            platform: windows
            arch: x86_64
            node_arch: x64
            setup_script: setup-windows.ps1
          - os: macos-latest
            platform: macos
            arch: x86_64
            node_arch: x64
            setup_script: setup-macos.sh
          - os: macos-14  # Apple Silicon
            platform: macos
            arch: aarch64
            node_arch: arm64
            setup_script: setup-macos.sh
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # Rust ç¯å¢ƒè®¾ç½®
    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.arch }}-unknown-${{ matrix.platform }}-gnu

    # Node.js ç¯å¢ƒè®¾ç½®ï¼ˆç”¨äºå‰ç«¯ï¼‰
    - name: å®‰è£… Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        architecture: ${{ matrix.node_arch }}

    # ç¼“å­˜ä¼˜åŒ–
    - name: ç¼“å­˜ Cargo ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
          node_modules
        key: ${{ runner.os }}-${{ matrix.arch }}-cargo-node-${{ hashFiles('**/Cargo.lock', '**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-cargo-
          ${{ runner.os }}-${{ matrix.arch }}-node-

    # å¹³å°ç‰¹å®šçš„ä¾èµ–å®‰è£…
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.0-dev \
          build-essential \
          curl \
          wget \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsqlite3-dev \
          pkg-config

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: matrix.platform == 'macos'
      run: |
        # å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
        xcode-select --install 2>/dev/null || true
        # å®‰è£… Homebrew ä¾èµ–
        brew install sqlite3

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Windows)
      if: matrix.platform == 'windows'
      shell: powershell
      run: |
        # Windows é€šå¸¸ä¸éœ€è¦é¢å¤–çš„ç³»ç»Ÿä¾èµ–ï¼ŒTauri ä¼šå¤„ç†
        # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Visual Studio æ„å»ºå·¥å…·
        Write-Host "Windows dependencies check complete"

    # ç¯å¢ƒéªŒè¯
    - name: éªŒè¯ç¯å¢ƒ
      run: |
        echo "å¹³å°ä¿¡æ¯:"
        uname -a || ver
        echo "Rust ç‰ˆæœ¬:"
        rustc --version
        echo "Cargo ç‰ˆæœ¬:"
        cargo --version
        echo "Node.js ç‰ˆæœ¬:"
        node --version
        echo "npm ç‰ˆæœ¬:"
        npm --version

    # æ„å»ºé¡¹ç›®
    - name: æ„å»ºé¡¹ç›®
      run: cargo build --verbose --release

    # è¿è¡Œå•å…ƒæµ‹è¯•
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: cargo test --lib --bins --release

    # è¿è¡Œé›†æˆæµ‹è¯•
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: cargo test --test '*' --release

    # è·¨å¹³å°ç‰¹å®šæµ‹è¯•
    - name: æ–‡ä»¶è·¯å¾„å…¼å®¹æ€§æµ‹è¯•
      shell: bash
      run: |
        echo "æµ‹è¯•æ–‡ä»¶è·¯å¾„å¤„ç†..."
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶è·¯å¾„
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          TEST_PATH="C:\\temp\\ai_manager_test"
        else
          TEST_PATH="/tmp/ai_manager_test"
        fi
        echo "æµ‹è¯•è·¯å¾„: $TEST_PATH"
        
        # è¿è¡Œè·¯å¾„å¤„ç†æµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "tests/cross-platform" ]; then
          cargo test --test cross_platform_paths --release || true
        fi

    - name: é…ç½®æ–‡ä»¶ä½ç½®æµ‹è¯•
      shell: bash
      run: |
        echo "æµ‹è¯•é…ç½®æ–‡ä»¶ä½ç½®..."
        
        # æµ‹è¯•ä¸åŒå¹³å°çš„é…ç½®ç›®å½•
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          CONFIG_DIR="$APPDATA/AI Manager"
          CLAUDE_CONFIG="$APPDATA/.claude"
          CODEX_CONFIG="$APPDATA/.codex"
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          CONFIG_DIR="$HOME/Library/Application Support/AI Manager"
          CLAUDE_CONFIG="$HOME/.claude"
          CODEX_CONFIG="$HOME/.codex"
        else  # Linux
          CONFIG_DIR="$HOME/.config/ai-manager"
          CLAUDE_CONFIG="$HOME/.claude"
          CODEX_CONFIG="$HOME/.codex"
        fi
        
        echo "é…ç½®ç›®å½•: $CONFIG_DIR"
        echo "Claudeé…ç½®: $CLAUDE_CONFIG"
        echo "Codexé…ç½®: $CODEX_CONFIG"
        
        # åˆ›å»ºç›®å½•æµ‹è¯•æƒé™
        mkdir -p "$CONFIG_DIR" "$CLAUDE_CONFIG" "$CODEX_CONFIG"
        echo "ç›®å½•åˆ›å»ºæˆåŠŸ"
        
        # æµ‹è¯•æ–‡ä»¶å†™å…¥æƒé™
        echo "test" > "$CONFIG_DIR/test.txt"
        echo "test" > "$CLAUDE_CONFIG/test.txt"
        echo "test" > "$CODEX_CONFIG/test.txt"
        echo "æ–‡ä»¶å†™å…¥æƒé™æ­£å¸¸"

    # æ•°æ®åº“å…¼å®¹æ€§æµ‹è¯•
    - name: æ•°æ®åº“å…¼å®¹æ€§æµ‹è¯•
      shell: bash
      run: |
        echo "æµ‹è¯•æ•°æ®åº“å…¼å®¹æ€§..."
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®åº“
        if [ -f "tests/data/test_migration.db" ]; then
          cp tests/data/test_migration.db test_cross_platform.db
          echo "æµ‹è¯•æ•°æ®åº“å¤åˆ¶æˆåŠŸ"
        else
          echo "åˆ›å»ºæ–°çš„æµ‹è¯•æ•°æ®åº“"
          sqlite3 test_cross_platform.db "CREATE TABLE test (id INTEGER PRIMARY KEY, data TEXT);"
          sqlite3 test_cross_platform.db "INSERT INTO test (data) VALUES ('è·¨å¹³å°æµ‹è¯•æ•°æ®');"
        fi
        
        # éªŒè¯æ•°æ®åº“è®¿é—®
        sqlite3 test_cross_platform.db "SELECT * FROM test;"
        echo "æ•°æ®åº“è®¿é—®æ­£å¸¸"

    # åŠ å¯†å…¼å®¹æ€§æµ‹è¯•
    - name: åŠ å¯†å…¼å®¹æ€§æµ‹è¯•
      shell: bash
      run: |
        echo "æµ‹è¯•åŠ å¯†å…¼å®¹æ€§..."
        
        # è¿è¡ŒåŠ å¯†æµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "tests/encryption_compatibility_test.rs" ]; then
          cargo test --test encryption_compatibility --release || true
        fi
        
        echo "åŠ å¯†æµ‹è¯•å®Œæˆ"

    # æ„å»ºæ¡Œé¢åº”ç”¨ï¼ˆå¯é€‰ï¼Œç”¨äºéªŒè¯æ‰“åŒ…ï¼‰
    - name: æ„å»ºæ¡Œé¢åº”ç”¨
      if: success()  # åªæœ‰åœ¨å‰é¢æ­¥éª¤æˆåŠŸæ—¶æ‰è¿è¡Œ
      run: |
        # å®‰è£… Tauri CLIï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
        cargo install tauri-cli --version "^1.0" --quiet
        
        # æ„å»ºåº”ç”¨ï¼ˆä¸ç”Ÿæˆå®‰è£…åŒ…ï¼ŒåªéªŒè¯æ„å»ºè¿‡ç¨‹ï¼‰
        cd src-tauri
        cargo tauri build --no-bundle
        cd ..
        
        echo "æ¡Œé¢åº”ç”¨æ„å»ºæˆåŠŸ"

    # æ€§èƒ½åŸºå‡†æµ‹è¯•
    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      if: success() && matrix.platform == 'linux'  # åªåœ¨Linuxä¸Šè¿è¡Œæ€§èƒ½æµ‹è¯•ä»¥èŠ‚çœæ—¶é—´
      run: |
        echo "è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        
        # å®‰è£… cargo-criterionï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
        cargo install cargo-criterion --quiet
        
        # è¿è¡ŒåŸºå‡†æµ‹è¯•
        cargo bench --bench performance || true
        
        echo "æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

    # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿç”ŸæˆæŠ¥å‘Š
      shell: bash
      run: |
        echo "ç”Ÿæˆè·¨å¹³å°æµ‹è¯•æŠ¥å‘Š..."
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p cross-platform-reports
        
        # ç”Ÿæˆå¹³å°æŠ¥å‘Š
        cat > cross-platform-reports/report-${{ matrix.platform }}-${{ matrix.arch }}.md << EOF
        # è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•æŠ¥å‘Š
        
        ## å¹³å°ä¿¡æ¯
        - æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}
        - å¹³å°: ${{ matrix.platform }}
        - æ¶æ„: ${{ matrix.arch }}
        - Node.jsæ¶æ„: ${{ matrix.node_arch }}
        
        ## æµ‹è¯•æ—¶é—´
        - å¼€å§‹æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - Git SHA: ${{ github.sha }}
        - åˆ†æ”¯: ${{ github.ref_name }}
        
        ## æµ‹è¯•ç»“æœ
        - æ„å»ºçŠ¶æ€: ${{ job.status }}
        
        ## ç¯å¢ƒä¿¡æ¯
        \`\`\`
        Rustç‰ˆæœ¬: $(rustc --version 2>/dev/null || echo "æœªå®‰è£…")
        Node.jsç‰ˆæœ¬: $(node --version 2>/dev/null || echo "æœªå®‰è£…")
        \`\`\`
        
        EOF
        
        echo "æŠ¥å‘Šç”Ÿæˆå®Œæˆ: cross-platform-reports/report-${{ matrix.platform }}-${{ matrix.arch }}.md"

    # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cross-platform-report-${{ matrix.platform }}-${{ matrix.arch }}
        path: cross-platform-reports/
        retention-days: 30

  # æ±‡æ€»æµ‹è¯•ç»“æœ
  test-summary:
    name: è·¨å¹³å°æµ‹è¯•æ±‡æ€»
    if: always()
    needs: test-matrix
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        path: all-reports/

    - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•æ±‡æ€»æŠ¥å‘Š" > cross-platform-summary.md
        echo "" >> cross-platform-summary.md
        echo "**æµ‹è¯•æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> cross-platform-summary.md
        echo "**Git SHA:** ${{ github.sha }}" >> cross-platform-summary.md
        echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> cross-platform-summary.md
        echo "" >> cross-platform-summary.md
        
        echo "## æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> cross-platform-summary.md
        echo "" >> cross-platform-summary.md
        
        # éå†æ‰€æœ‰æŠ¥å‘Šæ–‡ä»¶
        for report_dir in all-reports/cross-platform-report-*; do
          if [ -d "$report_dir" ]; then
            platform_name=$(echo "$report_dir" | sed 's/.*cross-platform-report-//')
            echo "### $platform_name" >> cross-platform-summary.md
            
            if [ -f "$report_dir/report-$platform_name.md" ]; then
              cat "$report_dir/report-$platform_name.md" >> cross-platform-summary.md
              echo "" >> cross-platform-summary.md
            fi
          fi
        done
        
        echo "## ç»“è®º" >> cross-platform-summary.md
        echo "è¯¦ç»†çš„æµ‹è¯•ç»“æœè¯·å‚è€ƒå„ä¸ªå¹³å°çš„å•ç‹¬æŠ¥å‘Šã€‚" >> cross-platform-summary.md
        
        # æ˜¾ç¤ºæ±‡æ€»æŠ¥å‘Š
        cat cross-platform-summary.md

    - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: cross-platform-summary
        path: cross-platform-summary.md
        retention-days: 90

    # åœ¨ PR ä¸­è¯„è®ºæµ‹è¯•ç»“æœ
    - name: PR è¯„è®º
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = './cross-platform-summary.md';
          
          if (fs.existsSync(path)) {
            const summary = fs.readFileSync(path, 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸŒ è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•æŠ¥å‘Š\n\n${summary}`
            });
          }