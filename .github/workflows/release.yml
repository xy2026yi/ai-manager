name: æ„å»ºå’Œå‘å¸ƒ AI Manager

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-0 \
          libwebkit2gtk-4.1-dev \
          libnotify4 \
          libnss3 \
          libxss1 \
          libxtst6 \
          xdg-utils \
          libatspi2.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxkbcommon0 \
          libxfixes3 \
          libgtk-3-dev \
          libpango1.0-dev \
          libjavascriptcoregtk-4.1-0 \
          libjavascriptcoregtk-4.1-dev \
          libglib2.0-dev \
          pkg-config \
          build-essential

    - name: åˆ›å»ºå…¼å®¹æ€§è½¯é“¾æ¥
      run: |
        # ä¸ºæ–°ç‰ˆæœ¬ Ubuntu åˆ›å»º libwebkit2gtk-4.0 å…¼å®¹é“¾æ¥
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so.0
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so

        # ä¸ºæ–°ç‰ˆæœ¬ Ubuntu åˆ›å»º libjavascriptcoregtk-4.0 å…¼å®¹é“¾æ¥
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so.0
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so

        # éªŒè¯é“¾æ¥åˆ›å»ºæˆåŠŸ
        ls -la /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so*
        ls -la /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so*

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: å®‰è£… Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£…ä¾èµ–
      run: npm install

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      working-directory: src-tauri
      run: cargo fmt -- --check

    - name: Clippy æ£€æŸ¥
      working-directory: src-tauri
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: è¿è¡Œæµ‹è¯•
      working-directory: src-tauri
      run: cargo test --all-features

  # æ„å»ºå¤šå¹³å°å®‰è£…åŒ…
  build:
    name: æ„å»ºåº”ç”¨ (${{ matrix.target }})
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            ext: .exe
            bundle: msi
          # macOS
          - platform: macos-latest
            target: aarch64-apple-darwin
            ext: ""
            bundle: app
          # Linux
          - platform: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: ""
            bundle: appimage

    runs-on: ${{ matrix.platform }}

    steps:
    - uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: å®‰è£… Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£… Linux ä¾èµ–
      if: matrix.target == 'x86_64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-0 \
          libwebkit2gtk-4.1-dev \
          libnotify4 \
          libnss3 \
          libxss1 \
          libxtst6 \
          xdg-utils \
          libatspi2.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxkbcommon0 \
          libxfixes3 \
          libgtk-3-dev \
          libpango1.0-dev \
          libjavascriptcoregtk-4.1-0 \
          libjavascriptcoregtk-4.1-dev \
          libglib2.0-dev \
          pkg-config \
          build-essential

    - name: åˆ›å»ºå…¼å®¹æ€§è½¯é“¾æ¥
      if: matrix.target == 'x86_64-unknown-linux-gnu'
      run: |
        # ä¸ºæ–°ç‰ˆæœ¬ Ubuntu åˆ›å»º libwebkit2gtk-4.0 å…¼å®¹é“¾æ¥
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so.0
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so

        # ä¸ºæ–°ç‰ˆæœ¬ Ubuntu åˆ›å»º libjavascriptcoregtk-4.0 å…¼å®¹é“¾æ¥
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so.0
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so

        # éªŒè¯é“¾æ¥åˆ›å»ºæˆåŠŸ
        ls -la /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so*
        ls -la /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so*

    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: npm install

    - name: æ„å»ºå‰ç«¯
      run: npm run build

    - name: æ„å»º Rust åº”ç”¨
      working-directory: src-tauri
      run: cargo build --release --target ${{ matrix.target }}

    - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
      if: matrix.platform == 'windows-latest'
      working-directory: src-tauri
      run: |
        rustup target add x86_64-pc-windows-msvc
        cargo install tauri-cli --version "^1.0"

    - name: åˆ›å»º macOS Universal äºŒè¿›åˆ¶æ–‡ä»¶
      if: matrix.target == 'aarch64-apple-darwin'
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨æ„å»ºäº§ç‰©
        mkdir -p build-output
        echo "BUILD_TARGET=${{ matrix.target }}" >> $GITHUB_ENV
        echo "BUILD_OUTPUT=build-output" >> $GITHUB_ENV

    - name: æ„å»º Tauri åº”ç”¨
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tauriScript: npm run tauri
        args: --target ${{ matrix.target }}
        includeDebug: false
        includeRelease: true

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ai-manager-${{ matrix.target }}
        path: |
          src-tauri/target/${{ matrix.target }}/release/bundle/
          !src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dSYM/
        retention-days: 30

  # åˆ›å»º GitHub Release
  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-files
        find release-artifacts -name "*.exe" -type f -exec cp {} release-files/ \;
        find release-artifacts -name "*.msi" -type f -exec cp {} release-files/ \;
        find release-artifacts -name "*.app.tar.gz" -type f -exec cp {} release-files/ \;
        find release-artifacts -name "*.AppImage" -type f -exec cp {} release-files/ \;
        find release-artifacts -name "*.deb" -type f -exec cp {} release-files/ \;
        find release-artifacts -name "*.rpm" -type f -exec cp {} release-files/ \;

        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨å’Œå“ˆå¸Œå€¼
        cd release-files
        sha256sum * > SHA256SUMS
        ls -la > FILES

    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        cat > release-notes.md << 'EOF'
        # AI Manager ${{ steps.version.outputs.version }} å‘å¸ƒ

        ğŸš€ AI Manager æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½çš„AIå·¥å…·ç®¡ç†å¹³å°ï¼Œä» Python/FastAPI è¿ç§»åˆ° Rust/Tauri æ¶æ„ã€‚

        ## ğŸ“¦ ä¸‹è½½å®‰è£…

        ### Windows
        - **å®‰è£…åŒ…**: `AI-Manager_${{ steps.version.outputs.version_number }}_x64-setup.exe`
        - **ä¾¿æºç‰ˆ**: `AI-Manager_${{ steps.version.outputs.version_number }}_x64-portable.exe`

        ### macOS
        - **Apple Silicon**: `AI-Manager_${{ steps.version.outputs.version_number }}_aarch64.app.tar.gz`

        ### Linux
        - **AppImage**: `AI-Manager_${{ steps.version.outputs.version_number }}_amd64.AppImage`
        - **Debian/Ubuntu**: `ai-manager_${{ steps.version.outputs.version_number }}_amd64.deb`

        ## âœ¨ æ–°ç‰¹æ€§

        - ğŸ¯ è½»é‡çº§è®¾è®¡ï¼šå®‰è£…åŒ…å°äº 15MB
        - âš¡ é«˜æ€§èƒ½ï¼šå¯åŠ¨æ—¶é—´ < 2 ç§’ï¼Œå†…å­˜å ç”¨ < 100MB
        - ğŸ›¡ï¸ æ•°æ®å®‰å…¨ï¼šæœ¬åœ°åŠ å¯†å­˜å‚¨
        - ğŸŒ è·¨å¹³å°ï¼šWindowsã€macOSã€Linux å…¨å¹³å°æ”¯æŒ
        - ğŸ‡¨ğŸ‡³ ä¸­æ–‡ä¼˜åŒ–ï¼šå®Œæ•´çš„ä¸­æ–‡ç•Œé¢å’Œæ–‡æ¡£

        ## ğŸ”§ ç³»ç»Ÿè¦æ±‚

        - Windows 10+ / macOS 10.13+ / Linux (Ubuntu 18.04+)
        - 2GB RAM (æ¨è 4GB+)
        - 100MB å¯ç”¨ç£ç›˜ç©ºé—´

        ## ğŸ“š æ–‡æ¡£

        - [ç”¨æˆ·æ‰‹å†Œ](https://docs.xxx.com/user-manual)
        - [å®‰è£…æŒ‡å—](https://docs.xxx.com/installation-guide)
        - [æ•…éšœæ’é™¤](https://docs.xxx.com/troubleshooting)

        ## ğŸ” å®‰å…¨

        æ‰€æœ‰å®‰è£…åŒ…éƒ½ç»è¿‡æ•°å­—ç­¾åéªŒè¯ï¼Œç¡®ä¿ä¸‹è½½çš„æ–‡ä»¶å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚

        ## ğŸ†• æ›´æ–°è¯´æ˜

        æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
        - å®Œæ•´çš„ Rust/Tauri æ¶æ„è¿ç§»
        - æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ä½¿ç”¨æ”¹è¿›
        - å¢å¼ºçš„ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ
        - å®Œå–„çš„ä¸­æ–‡æœ¬åœ°åŒ–æ”¯æŒ
        - å…¨é¢çš„æµ‹è¯•è¦†ç›–å’Œæ–‡æ¡£

        ---

        **éªŒè¯å“ˆå¸Œ**: [SHA256SUMS](./release-files/SHA256SUMS)
        **æ–‡ä»¶åˆ—è¡¨**: [FILES](./release-files/FILES)
        EOF

        echo "release_notes_file=release-notes.md" >> $GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: AI Manager ${{ steps.version.outputs.version }}
        body_path: ${{ steps.release_notes.outputs.release_notes_file }}
        files: |
          release-files/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify:
    name: æ„å»ºé€šçŸ¥
    needs: [build, release]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      if: needs.build.result == 'success'
      run: |
        echo "âœ… AI Manager ${{ github.ref_name }} æ„å»ºæˆåŠŸ!"
        echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifacts"
        if: startsWith(github.ref, 'refs/tags/v')
        echo "ğŸ‰ å‘å¸ƒç‰ˆæœ¬å·²åˆ›å»º: https://github.com/${{ github.repository }}/releases"

    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ AI Manager æ„å»ºå¤±è´¥!"
        echo "ğŸ” è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        exit 1