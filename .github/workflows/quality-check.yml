name: 代码质量检查

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Rust 代码质量检查
  rust-quality:
    name: Rust 代码质量
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: 安装 Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: 缓存 Cargo 依赖
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: 检查 Cargo.toml 格式
      run: cargo check --message-format=short

    - name: 代码格式检查
      run: cargo fmt --all -- --check

    - name: Clippy 静态分析
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: 运行单元测试
      run: cargo test --lib --all-features

    - name: 运行集成测试
      run: cargo test --test '*' --all-features

  # 文档检查
  docs:
    name: 文档检查
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: 检查用户文档
      run: |
        # 检查用户手册是否存在且完整
        if [ -f "docs/user-manual.md" ]; then
          echo "✅ 用户手册存在"
        else
          echo "❌ 用户手册缺失"
          exit 1
        fi

        # 检查安装指南
        if [ -f "docs/installation-guide.md" ]; then
          echo "✅ 安装指南存在"
        else
          echo "❌ 安装指南缺失"
          exit 1
        fi

        # 检查故障排除指南
        if [ -f "docs/troubleshooting.md" ]; then
          echo "✅ 故障排除指南存在"
        else
          echo "❌ 故障排除指南缺失"
          exit 1
        fi

  # 最终质量报告
  quality-report:
    name: 质量报告
    needs: [rust-quality, docs]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: 生成质量报告
      run: |
        echo "# AI Manager 代码质量报告" > quality-report.md
        echo "" >> quality-report.md
        echo "## 构建信息" >> quality-report.md
        echo "- **提交**: ${{ github.sha }}" >> quality-report.md
        echo "- **分支**: ${{ github.ref_name }}" >> quality-report.md
        echo "- **时间**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> quality-report.md
        echo "" >> quality-report.md

        echo "## 质量检查结果" >> quality-report.md
        echo "- Rust 代码质量: ${{ needs.rust-quality.result }}" >> quality-report.md
        echo "- 文档检查: ${{ needs.docs.result }}" >> quality-report.md

        # 添加检查状态图标
        echo "" >> quality-report.md
        echo "## 详细状态" >> quality-report.md
        [ "${{ needs.rust-quality.result }}" = "success" ] && echo "✅ Rust 代码质量检查通过" || echo "❌ Rust 代码质量检查失败" >> quality-report.md
        [ "${{ needs.docs.result }}" = "success" ] && echo "✅ 文档检查通过" || echo "❌ 文档检查失败" >> quality-report.md

        cat quality-report.md

    - name: 上传质量报告
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30